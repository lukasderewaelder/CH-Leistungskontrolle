<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mündliche Prüfung - Assistent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- MathJax für Formeln -->
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
            svg: { fontCache: 'global' }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Scrollbar für Editor Tabelle */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { bg-slate-100; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Listen-Styles für Markdown Rendering */
        .prose ul { list-style-type: disc; padding-left: 1.5rem; margin-top: 0.5rem; margin-bottom: 0.5rem; }
        .prose li { padding-left: 0.25rem; }
        .prose strong { font-weight: 700; color: #1e293b; }

        /* Drag & Drop Styles */
        tr.dragging { opacity: 0.5; background-color: #f1f5f9; }
        tr.over { border-bottom: 2px solid #6366f1; }
        .cursor-grab { cursor: grab; }
        .cursor-grab:active { cursor: grabbing; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen flex flex-col">

    <!-- HEADER -->
    <header class="bg-white border-b border-slate-200 p-4 flex justify-between items-center shadow-sm z-10">
        <div class="flex items-center gap-2">
            <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
            <h1 class="font-bold text-xl text-slate-700">Prüfungs-Assistent</h1>
        </div>
        <button onclick="resetApp()" class="text-sm text-red-500 hover:text-red-700 font-medium">Reset / Neue Session</button>
    </header>

    <!-- MAIN CONTENT AREA -->
    <main class="flex-grow p-6 overflow-y-auto relative custom-scrollbar">
        
        <!-- SECTION 1: SETUP & CONFIG (Visible initially) -->
        <div id="setup-section" class="max-w-4xl mx-auto space-y-8 fade-in">
            
            <!-- Upload Card -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
                    <h2 class="text-lg font-semibold flex items-center gap-2">
                        <span class="bg-indigo-100 text-indigo-700 w-6 h-6 rounded-full flex items-center justify-center text-xs">1</span>
                        Fragen-Pool
                    </h2>
                    <div class="flex gap-2">
                        <button onclick="clearStorage()" id="btn-clear-storage" class="hidden text-sm text-red-500 border border-red-200 hover:bg-red-50 px-3 py-1 rounded transition-colors flex items-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            Pool leeren
                        </button>
                        <button onclick="openEditor()" class="text-sm bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 py-1 rounded border border-slate-300 transition-colors flex items-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                            Bearbeiten / Manuell
                        </button>
                    </div>
                </div>
                
                <div class="border-2 border-dashed border-slate-300 rounded-lg p-8 text-center hover:bg-slate-50 transition-colors relative group">
                    <input type="file" id="csvFile" accept=".csv" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" onchange="handleFileUpload(this)">
                    <div id="upload-placeholder" class="group-hover:scale-105 transition-transform">
                        <svg class="w-10 h-10 text-slate-300 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                        <p class="text-slate-600 font-medium">CSV Datei hier ablegen oder klicken</p>
                        <p class="text-xs text-slate-400 mt-2">Format: ID; Frage; Punkte (ohne Kopfzeile)</p>
                    </div>
                    <div id="file-info" class="hidden text-emerald-600 font-semibold flex flex-col items-center">
                        <div class="flex items-center gap-2 mb-2">
                             <svg class="w-10 h-10 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </div>
                       
                        <span><span id="question-count">0</span> Fragen bereit.</span>
                        <span class="text-xs text-slate-400 mt-1 font-normal">(Im Browser gespeichert)</span>
                    </div>
                </div>
            </div>

            <!-- Settings Card -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 opacity-50 pointer-events-none transition-opacity" id="settings-card">
                <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                    <span class="bg-indigo-100 text-indigo-700 w-6 h-6 rounded-full flex items-center justify-center text-xs">2</span>
                    Einstellungen
                </h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Filter ID -->
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">Fragen-ID Bereich</label>
                        <div class="flex gap-2 items-center">
                            <input type="number" id="min-id" placeholder="Min" class="w-full p-2 border rounded focus:ring-2 focus:ring-indigo-500 outline-none text-slate-700">
                            <span class="text-slate-400">-</span>
                            <input type="number" id="max-id" placeholder="Max" class="w-full p-2 border rounded focus:ring-2 focus:ring-indigo-500 outline-none text-slate-700">
                        </div>
                        <p class="text-xs text-slate-400 mt-1">Leer lassen für alle Fragen.</p>
                    </div>

                    <!-- Exclude IDs -->
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">Ausschluss (IDs)</label>
                        <input type="text" id="exclude-ids" placeholder="z.B. 3, 7, 20-25" class="w-full p-2 border rounded focus:ring-2 focus:ring-indigo-500 outline-none text-slate-700">
                        <p class="text-xs text-slate-400 mt-1">Kommagetrennt. Bereiche mit Bindestrich.</p>
                    </div>
                </div>

                <div class="mt-8 pt-4 border-t border-slate-100 flex justify-end">
                    <button onclick="startExam()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-semibold shadow transition-transform active:scale-95 flex items-center gap-2">
                        Prüfung starten
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- SECTION 1.5: EDITOR MODE (Hidden initially) -->
        <div id="editor-section" class="hidden max-w-7xl mx-auto h-full flex flex-col fade-in">
            <div class="bg-white rounded-xl shadow-lg border border-slate-200 flex flex-col h-[80vh]">
                <div class="p-4 border-b border-slate-200 flex justify-between items-center bg-slate-50 rounded-t-xl">
                    <h2 class="font-bold text-lg text-slate-700">Fragenpool bearbeiten</h2>
                    <div class="flex gap-2">
                         <button onclick="exportCSV()" class="text-sm bg-white border border-slate-300 hover:bg-slate-50 text-slate-600 px-3 py-1.5 rounded flex items-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            Export CSV
                        </button>
                        <button onclick="saveAndCloseEditor()" class="text-sm bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-1.5 rounded font-medium">
                            Speichern & Zurück
                        </button>
                    </div>
                </div>
                
                <div class="flex-grow overflow-auto custom-scrollbar p-4">
                    <table class="w-full text-sm text-left text-slate-500">
                        <thead class="text-xs text-slate-700 uppercase bg-slate-100 sticky top-0 z-10">
                            <tr>
                                <th scope="col" class="px-3 py-3 w-8"></th>
                                <th scope="col" class="px-3 py-3 w-16">ID</th>
                                <th scope="col" class="px-3 py-3">Frage (LaTeX mit $)</th>
                                <th scope="col" class="px-3 py-3 w-20">Pkt.</th>
                                <th scope="col" class="px-3 py-3 w-10"></th>
                            </tr>
                        </thead>
                        <tbody id="editor-table-body">
                            <!-- Rows via JS -->
                        </tbody>
                    </table>
                    <button onclick="addEditorRow()" class="mt-4 w-full py-2 border-2 border-dashed border-slate-300 text-slate-500 hover:text-indigo-600 hover:border-indigo-300 rounded-lg transition-colors flex justify-center items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        Neue Frage hinzufügen
                    </button>
                </div>
            </div>
        </div>


        <!-- SECTION 2: EXAM MODE (Hidden initially) -->
        <div id="exam-section" class="hidden max-w-6xl mx-auto h-full flex flex-col fade-in">
            
            <!-- Progress Dashboard -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <!-- Question Counter -->
                <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm relative overflow-hidden">
                    <div class="flex justify-between items-end relative z-10">
                        <div>
                            <p class="text-xs text-slate-500 uppercase font-bold tracking-wider">Gestellte Fragen</p>
                            <p class="text-2xl font-bold text-slate-800"><span id="display-q-count">0</span> / 5<span class="text-xs font-normal text-slate-400 ml-1">(Min)</span></p>
                        </div>
                        <div id="status-icon-q" class="text-slate-300">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                        </div>
                    </div>
                    <!-- Progress Bar Background -->
                    <div class="absolute bottom-0 left-0 h-1 bg-slate-100 w-full">
                        <div id="progress-bar-q" class="h-full bg-blue-500 transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Points Counter -->
                <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm relative overflow-hidden">
                    <div class="flex justify-between items-end relative z-10">
                        <div>
                            <p class="text-xs text-slate-500 uppercase font-bold tracking-wider">Erreichte Punkte</p>
                            <p class="text-2xl font-bold text-slate-800"><span id="display-points">0</span> / 12<span class="text-xs font-normal text-slate-400 ml-1">(Min)</span></p>
                        </div>
                        <div id="status-icon-p" class="text-slate-300">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                        </div>
                    </div>
                     <!-- Progress Bar Background -->
                     <div class="absolute bottom-0 left-0 h-1 bg-slate-100 w-full">
                        <div id="progress-bar-p" class="h-full bg-orange-500 transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Card Container -->
            <div class="flex-grow flex flex-col gap-4">
                
                <!-- Question Card -->
                <div class="bg-white rounded-xl shadow-md border-l-4 border-indigo-500 p-8 relative flex-grow flex flex-col justify-center min-h-[200px]">
                    <div class="absolute top-4 left-4 flex gap-2">
                        <span class="bg-slate-100 text-slate-600 px-2 py-1 rounded text-xs font-mono border border-slate-200">ID: <span id="q-id">--</span></span>
                        <span class="bg-slate-50 text-slate-400 px-2 py-1 rounded text-xs border border-slate-100" title="Verbleibende Fragen im Pool">Pool: <span id="pool-remaining">?</span></span>
                    </div>
                    
                    <span class="absolute top-4 right-4 bg-indigo-50 text-indigo-700 px-3 py-1 rounded-full text-sm font-bold border border-indigo-100"><span id="q-points">0</span> Punkte</span>
                    
                    <div class="text-2xl md:text-3xl font-medium text-slate-800 leading-relaxed text-center my-4 prose max-w-none" id="q-text">
                        Frage wird geladen...
                    </div>
                </div>

            </div>

            <!-- Controls Footer -->
            <div class="mt-6 flex justify-end items-center bg-white p-4 rounded-xl shadow-lg border border-slate-100">
                <div class="flex gap-2">
                    <button id="btn-skip" onclick="skipQuestion()" class="bg-slate-100 hover:bg-slate-200 text-slate-600 px-4 py-3 rounded-lg font-medium shadow-sm border border-slate-200 flex items-center gap-2 transition-transform active:scale-95">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path></svg>
                        <span>Überspringen</span>
                    </button>

                    <button id="btn-next" onclick="nextQuestion()" class="bg-slate-800 hover:bg-slate-900 text-white px-6 py-3 rounded-lg font-semibold shadow-lg flex items-center gap-2 transition-transform active:scale-95">
                        <span>Nächste Frage</span>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path></svg>
                    </button>
                    
                    <button id="btn-finish" onclick="finishExam()" class="hidden bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold shadow-lg flex items-center gap-2 transition-transform active:scale-95 animate-pulse">
                        <span>Prüfung beenden</span>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                    </button>
                </div>
            </div>

        </div>

        <!-- FINISH SECTION (Adaptive Grid for iPad/Landscape) -->
        <div id="finish-section" class="hidden h-full flex flex-col items-center fade-in pb-10">
            
            <div class="max-w-6xl w-full mt-6 grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
                
                <!-- Left Column: Summary Card (Sticky on Large Screens) -->
                <div class="lg:col-span-4 lg:sticky lg:top-4 bg-white p-8 rounded-2xl shadow-xl border border-slate-200 text-center">
                    <div class="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6">
                        <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </div>
                    <h2 class="text-3xl font-bold text-slate-800 mb-2">Prüfung beendet</h2>
                    <p class="text-slate-500 mb-8">Alle Anforderungen wurden erfüllt.</p>
                    
                    <div class="bg-slate-50 rounded-lg p-6 mb-8 text-left">
                        <div class="flex justify-between mb-2 border-b border-slate-200 pb-2">
                            <span class="text-slate-600">Gesamtpunkte:</span>
                            <span class="font-bold text-slate-800 text-xl" id="final-points">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-600">Gestellte Fragen:</span>
                            <span class="font-bold text-slate-800 text-xl" id="final-count">0</span>
                        </div>
                    </div>

                    <button onclick="location.reload()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700">
                        Neue Prüfung starten
                    </button>
                </div>

                <!-- Right Column: History List -->
                <div class="lg:col-span-8 bg-white p-8 rounded-2xl shadow-xl border border-slate-200">
                     <h3 class="text-lg font-bold text-slate-700 mb-6 flex items-center gap-2 pb-4 border-b border-slate-100">
                        <svg class="w-5 h-5 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
                        Übersicht der gestellten Fragen
                    </h3>
                    <div id="history-list" class="space-y-4">
                        <!-- History Items injected via JS -->
                    </div>
                </div>

            </div>
        </div>

    </main>

    <script>
        // --- STATE MANAGEMENT ---
        let allQuestions = [];
        let sessionQuestions = [];
        let history = []; // Speichert gestellte Fragen
        let currentQuestion = null;
        let dragSrcEl = null; // Drag & Drop Source
        
        let stats = {
            points: 0,
            questions: 0
        };

        const MIN_POINTS = 12;
        const MIN_QUESTIONS = 5;
        const STORAGE_KEY = 'oralExamQuestions';

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            loadFromStorage();
        });

        // --- STORAGE FUNCTIONS ---

        function saveToStorage() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(allQuestions));
            } catch (e) {
                console.error("Fehler beim Speichern:", e);
                alert("Fehler: Speicherplatz voll oder deaktiviert.");
            }
        }

        function loadFromStorage() {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                try {
                    allQuestions = JSON.parse(stored);
                    if (allQuestions.length > 0) {
                        updateSetupUI();
                    }
                } catch (e) {
                    console.error("Fehler beim Laden:", e);
                }
            }
        }

        function clearStorage() {
            if(confirm("Möchten Sie den gespeicherten Fragenpool wirklich löschen?")) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }

        // --- HELPER: MARKDOWN PARSER (SIMPLE) ---
        function parseMarkdown(text) {
            if (!text) return '';
            // Basic HTML escape
            let safe = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
            
            // Bold (**text**)
            safe = safe.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Lists (- item)
            // We split by newline to handle lists line-by-line
            let lines = safe.split('\n');
            let html = '';
            let inList = false;

            lines.forEach(line => {
                let trimmed = line.trim();
                // Check for list item (starts with - or *)
                if (trimmed.startsWith('- ') || trimmed.startsWith('* ')) {
                    if (!inList) {
                        html += '<ul>';
                        inList = true;
                    }
                    html += `<li>${trimmed.substring(2)}</li>`;
                } else {
                    if (inList) {
                        html += '</ul>';
                        inList = false;
                    }
                    if (trimmed.length > 0) {
                         html += line + '<br>';
                    }
                }
            });
            if (inList) html += '</ul>';
            
            return html;
        }


        // --- SETUP & ROBUSTER CSV PARSER ---

        function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                parseCSV(text);
            };
            reader.readAsText(file);
        }

        function parseCSV(csvText) {
            // Entferne potenzielles BOM (Byte Order Mark) am Anfang der Datei, was parseInt stören kann
            if (csvText.charCodeAt(0) === 0xFEFF) {
                csvText = csvText.slice(1);
            }

            const questions = [];
            let rows = [];
            
            let row = [];
            let currentVal = '';
            let inQuotes = false;
            
            // Trennzeichen dynamisch ermitteln (Semikolon bevorzugt)
            let delimiter = ';';
            if (!csvText.includes(';') && csvText.includes(',')) delimiter = ',';

            // Zeichen für Zeichen durchgehen, um Anführungszeichen (Excel-Umbrüche) richtig zu verarbeiten
            for (let i = 0; i < csvText.length; i++) {
                let char = csvText[i];
                let nextChar = csvText[i+1];

                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        // Escaptes Anführungszeichen ("")
                        currentVal += '"';
                        i++; // Nächstes überspringen
                    } else {
                        // Zustand umschalten
                        inQuotes = !inQuotes;
                    }
                } else if (char === delimiter && !inQuotes) {
                    // Spalte zu Ende
                    row.push(currentVal);
                    currentVal = '';
                } else if ((char === '\n' || char === '\r') && !inQuotes) {
                    // Zeile zu Ende (nur wenn nicht innerhalb von Anführungszeichen)
                    if (char === '\r' && nextChar === '\n') {
                        i++; // \n überspringen
                    }
                    row.push(currentVal);
                    // Leere Zeilen ignorieren
                    if (row.some(val => val.trim() !== '')) {
                        rows.push(row);
                    }
                    row = [];
                    currentVal = '';
                } else {
                    currentVal += char;
                }
            }
            
            // Letzte Zeile (falls die Datei nicht mit einem Umbruch endet)
            if (currentVal !== '' || row.length > 0) {
                row.push(currentVal);
                if (row.some(val => val.trim() !== '')) {
                    rows.push(row);
                }
            }

            // Nun die fertig aufgeteilten Zeilen in Fragen-Objekte wandeln
            rows.forEach(parts => {
                if (parts.length < 2) return; // Brauchen mindestens ID und Text
                
                // Versuche ID auszulesen. Wenn das fehlschlägt, ist es sehr wahrscheinlich die Kopfzeile
                let id = parseInt(parts[0].trim());
                if (isNaN(id)) return; 

                // Text bereinigen (Abwärtskompatibilität für alte, unescaped Exporte dieser App mit \n)
                let qText = parts[1].trim().replace(/\\n/g, '\n');
                
                let points = 1; // Standardwert
                
                if (parts.length >= 3) {
                    // Suche die Punktzahl am Ende. 
                    // Unterstützt neues Format (Spalte 3) und altes Format mit gelöschter Lösung (Spalte 4)
                    let ptsStr = parts[parts.length - 1].trim();
                    let parsedPoints = parseFloat(ptsStr.replace(',', '.'));
                    
                    if (!isNaN(parsedPoints)) {
                        points = parsedPoints;
                    } else if (parts.length >= 4) {
                        // Fallback, falls die Tabelle noch 4 Spalten hatte und die Punkte in Spalte 3 standen
                        let ptsFallback = parseFloat(parts[2].trim().replace(',', '.'));
                        if (!isNaN(ptsFallback)) points = ptsFallback;
                    }
                }

                questions.push({
                    id: id,
                    text: qText,
                    points: points
                });
            });

            allQuestions = questions;
            saveToStorage(); // Speichern!
            updateSetupUI();
        }

        function updateSetupUI() {
            document.getElementById('question-count').innerText = allQuestions.length;
            document.getElementById('file-info').classList.remove('hidden');
            document.getElementById('upload-placeholder').classList.add('hidden');
            document.getElementById('settings-card').classList.remove('opacity-50', 'pointer-events-none');
            document.getElementById('btn-clear-storage').classList.remove('hidden');
            
            if (allQuestions.length > 0) {
                const ids = allQuestions.map(q => q.id);
                document.getElementById('min-id').value = Math.min(...ids);
                document.getElementById('max-id').value = Math.max(...ids);
            }
        }

        // --- EDITOR FUNCTIONS ---

        function openEditor() {
            document.getElementById('setup-section').classList.add('hidden');
            document.getElementById('editor-section').classList.remove('hidden');
            renderEditorRows();
        }

        function renderEditorRows() {
            const tbody = document.getElementById('editor-table-body');
            tbody.innerHTML = '';

            // Wenn leer, füge eine leere Zeile hinzu
            if (allQuestions.length === 0) {
                addEditorRow();
                return;
            }

            allQuestions.forEach((q, index) => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b hover:bg-slate-50 transition-colors align-top';
                
                // DRAG LOGIC: Initially NOT draggable
                row.addEventListener('dragstart', handleDragStart);
                row.addEventListener('dragover', handleDragOver);
                row.addEventListener('drop', handleDrop);
                row.addEventListener('dragend', handleDragEnd);

                // Using Textareas for Multi-line support
                row.innerHTML = `
                    <td class="px-3 py-2 text-center cursor-grab text-slate-300 hover:text-indigo-500 pt-3" title="Verschieben (Gedrückt halten)">
                        <svg class="w-5 h-5 mx-auto pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </td>
                    <td class="px-3 py-2"><input type="number" value="${q.id}" class="w-full border rounded p-1 text-slate-700 bg-transparent focus:bg-white focus:ring-2 ring-indigo-200 outline-none" placeholder="ID"></td>
                    <td class="px-3 py-2"><textarea rows="2" class="w-full border rounded p-1 text-slate-700 bg-transparent focus:bg-white focus:ring-2 ring-indigo-200 outline-none custom-scrollbar" placeholder="Fragetext">${q.text.replace(/"/g, '&quot;')}</textarea></td>
                    <td class="px-3 py-2"><input type="number" step="0.5" value="${q.points}" class="w-full border rounded p-1 text-slate-700 bg-transparent focus:bg-white focus:ring-2 ring-indigo-200 outline-none"></td>
                    <td class="px-3 py-2 text-center pt-3">
                        <button onclick="deleteEditorRow(this)" class="text-slate-400 hover:text-red-500 transition-colors" title="Löschen">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
                
                // Add Handle Logic
                const handle = row.querySelector('.cursor-grab');
                handle.addEventListener('mousedown', () => {
                    row.setAttribute('draggable', 'true');
                    const mouseUpHandler = () => {
                        row.setAttribute('draggable', 'false');
                        document.removeEventListener('mouseup', mouseUpHandler);
                    };
                    document.addEventListener('mouseup', mouseUpHandler);
                });
            });
        }

        function addEditorRow() {
            const tbody = document.getElementById('editor-table-body');
            const row = document.createElement('tr');
            
            // Auto-Increment ID Logik
            let nextId = 1;
            if (tbody.children.length > 0) {
                const lastIdInput = tbody.lastElementChild.querySelector('input[type="number"]');
                if(lastIdInput) nextId = parseInt(lastIdInput.value) + 1;
            } else if (allQuestions.length > 0) {
                 nextId = Math.max(...allQuestions.map(q => q.id)) + 1;
            }

            row.className = 'bg-white border-b hover:bg-slate-50 transition-colors fade-in align-top';
            // DRAG LOGIC
            row.addEventListener('dragstart', handleDragStart);
            row.addEventListener('dragover', handleDragOver);
            row.addEventListener('drop', handleDrop);
            row.addEventListener('dragend', handleDragEnd);

            row.innerHTML = `
                <td class="px-3 py-2 text-center cursor-grab text-slate-300 hover:text-indigo-500 pt-3" title="Verschieben (Gedrückt halten)">
                    <svg class="w-5 h-5 mx-auto pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </td>
                <td class="px-3 py-2"><input type="number" value="${nextId}" class="w-full border rounded p-1 text-slate-700 bg-transparent focus:bg-white focus:ring-2 ring-indigo-200 outline-none"></td>
                <td class="px-3 py-2"><textarea rows="2" class="w-full border rounded p-1 text-slate-700 bg-transparent focus:bg-white focus:ring-2 ring-indigo-200 outline-none custom-scrollbar" placeholder="Neue Frage"></textarea></td>
                <td class="px-3 py-2"><input type="number" step="0.5" value="1" class="w-full border rounded p-1 text-slate-700 bg-transparent focus:bg-white focus:ring-2 ring-indigo-200 outline-none"></td>
                <td class="px-3 py-2 text-center pt-3">
                    <button onclick="deleteEditorRow(this)" class="text-slate-400 hover:text-red-500 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </td>
            `;
            tbody.appendChild(row);
            
            // Add Handle Logic
            const handle = row.querySelector('.cursor-grab');
            handle.addEventListener('mousedown', () => {
                row.setAttribute('draggable', 'true');
                const mouseUpHandler = () => {
                    row.setAttribute('draggable', 'false');
                    document.removeEventListener('mouseup', mouseUpHandler);
                };
                document.addEventListener('mouseup', mouseUpHandler);
            });
            
            row.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // --- DRAG & DROP HANDLERS ---
        
        function handleDragStart(e) {
            // Drag only starts if set to true (via mousedown on handle)
            if (this.getAttribute('draggable') !== 'true') {
                e.preventDefault();
                return false;
            }
            dragSrcEl = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
            this.classList.add('dragging');
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            if (dragSrcEl !== this) {
                // Determine direction
                const tbody = document.getElementById('editor-table-body');
                const rows = Array.from(tbody.querySelectorAll('tr'));
                const oldIndex = rows.indexOf(dragSrcEl);
                const newIndex = rows.indexOf(this);
                
                // Move element in DOM (preserving input values implicitly by moving node)
                if (oldIndex < newIndex) {
                    this.parentNode.insertBefore(dragSrcEl, this.nextSibling);
                } else {
                    this.parentNode.insertBefore(dragSrcEl, this);
                }
                
                // Renumber IDs
                recalculateIds();
            }
            return false;
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            this.setAttribute('draggable', 'false'); // Reset Draggable State
        }

        function recalculateIds() {
            const tbody = document.getElementById('editor-table-body');
            const rows = tbody.querySelectorAll('tr');
            rows.forEach((row, index) => {
                const idInput = row.querySelector('input[type="number"]'); 
                if(idInput) {
                    idInput.value = index + 1;
                }
            });
        }

        function deleteEditorRow(btn) {
            const row = btn.closest('tr');
            row.remove();
        }

        function saveAndCloseEditor() {
            const tbody = document.getElementById('editor-table-body');
            const newQuestions = [];
            
            tbody.querySelectorAll('tr').forEach(row => {
                const inputs = row.querySelectorAll('input, textarea'); // Select Textareas too
                // Basic Validation: Frage muss Text haben. 
                // Index 0: ID, 1: Text(TA), 2: Points
                if (inputs[1].value.trim() !== "") {
                    newQuestions.push({
                        id: parseInt(inputs[0].value) || 0,
                        text: inputs[1].value.trim(),
                        points: parseFloat(inputs[2].value) || 0
                    });
                }
            });

            allQuestions = newQuestions;
            saveToStorage(); // Speichern!
            updateSetupUI();
            
            document.getElementById('editor-section').classList.add('hidden');
            document.getElementById('setup-section').classList.remove('hidden');
        }

        function exportCSV() {
            // Speichere erst aktuelle Eingaben
            saveAndCloseEditor(); 
            
            // BOM hinzufügen für bessere Excel-Kompatibilität bei Umlauten
            let csvContent = "data:text/csv;charset=utf-8,\uFEFFID;Frage;Punkte\n";
            
            allQuestions.forEach(q => {
                // Quotes maskieren (aus " wird "") und den ganzen Text in Quotes hüllen
                // Dadurch wird garantiert, dass Semikolons und Zeilenumbrüche IM Text von Excel erkannt werden.
                let safeText = q.text.replace(/"/g, '""');
                safeText = `"${safeText}"`;
                
                csvContent += `${q.id};${safeText};${q.points}\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "fragenpool_export.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Re-open Editor if user wants to continue there
            openEditor();
        }

        // --- EXAM LOGIC ---

        function startExam() {
            const minId = parseInt(document.getElementById('min-id').value) || -999999;
            const maxId = parseInt(document.getElementById('max-id').value) || 999999;
            const excludeInput = document.getElementById('exclude-ids').value;

            // Parse Exclusions
            const excludedIds = new Set();
            if (excludeInput) {
                const parts = excludeInput.split(',');
                parts.forEach(part => {
                    part = part.trim();
                    if (part.includes('-')) {
                        const range = part.split('-').map(Number);
                        if (range.length === 2 && !isNaN(range[0]) && !isNaN(range[1])) {
                            const start = Math.min(range[0], range[1]);
                            const end = Math.max(range[0], range[1]);
                            for (let i = start; i <= end; i++) excludedIds.add(i);
                        }
                    } else {
                        const id = parseInt(part);
                        if (!isNaN(id)) excludedIds.add(id);
                    }
                });
            }
            
            sessionQuestions = allQuestions.filter(q => {
                const inRange = q.id >= minId && q.id <= maxId;
                const notExcluded = !excludedIds.has(q.id);
                return inRange && notExcluded;
            });

            history = []; // Reset history

            if (sessionQuestions.length === 0) {
                alert("Keine Fragen im gewählten Bereich gefunden!");
                return;
            }

            document.getElementById('setup-section').classList.add('hidden');
            document.getElementById('exam-section').classList.remove('hidden');

            nextQuestion(true);
        }

        function nextQuestion(isFirst = false) {
            // Historisierung und Scoring der VORHERIGEN Frage
            if (!isFirst && currentQuestion) {
                stats.points += currentQuestion.points;
                stats.questions++;
                history.push(currentQuestion); // Zur Historie hinzufügen
                updateStatsUI();
            }

            if (sessionQuestions.length === 0) {
                alert("Alle Fragen aus diesem Bereich wurden gestellt!");
                finishExam();
                return;
            }

            checkFinishCondition();

            // ZUFALLSGENERATOR: Ziehen ohne Zurücklegen
            const randomIndex = Math.floor(Math.random() * sessionQuestions.length);
            currentQuestion = sessionQuestions[randomIndex];
            sessionQuestions.splice(randomIndex, 1); // Entferne gezogene Frage

            renderQuestion();
        }

        function skipQuestion() {
            // Die aktuelle Frage wird NICHT gewertet (keine Punkte, kein History-Eintrag)
            // Sie wird zurück in den Pool gelegt, falls wir sie später noch brauchen 
            // (verhindert, dass der Pool leer läuft bei vielen Skips).
            if (currentQuestion) {
                sessionQuestions.push(currentQuestion);
            }
            
            // Nächste Frage ziehen, als wäre es die Erste (also kein Scoring der vorherigen)
            nextQuestion(true);
        }

        function renderQuestion() {
            document.getElementById('q-id').innerText = currentQuestion.id;
            
            // USE PARSER instead of innerText
            document.getElementById('q-text').innerHTML = parseMarkdown(currentQuestion.text);

            document.getElementById('q-points').innerText = currentQuestion.points;
            
            // +1, da die aktuelle Frage gedanklich noch zum Pool gehört, bis sie übersprungen oder abgeschlossen wird
            document.getElementById('pool-remaining').innerText = sessionQuestions.length + 1;

            // MathJax re-render trigger für dynamischen Content
            if (window.MathJax) {
                MathJax.typesetPromise([document.getElementById('q-text')]).catch((err) => console.log(err));
            }
        }

        function updateStatsUI() {
            document.getElementById('display-q-count').innerText = stats.questions;
            // Formatierung der Punkte auf max 1 Nachkommastelle falls nötig
            const displayP = Number.isInteger(stats.points) ? stats.points : stats.points.toFixed(1);
            document.getElementById('display-points').innerText = displayP;
            
            const pctQ = Math.min((stats.questions / MIN_QUESTIONS) * 100, 100);
            const pctP = Math.min((stats.points / MIN_POINTS) * 100, 100);

            const barQ = document.getElementById('progress-bar-q');
            const barP = document.getElementById('progress-bar-p');

            barQ.style.width = pctQ + '%';
            barP.style.width = pctP + '%';

            if (stats.questions >= MIN_QUESTIONS) {
                barQ.classList.remove('bg-blue-500');
                barQ.classList.add('bg-green-500');
                document.getElementById('status-icon-q').classList.add('text-green-500');
            }
            if (stats.points >= MIN_POINTS) {
                barP.classList.remove('bg-orange-500');
                barP.classList.add('bg-green-500');
                document.getElementById('status-icon-p').classList.add('text-green-500');
            }

            checkFinishCondition();
        }

        function checkFinishCondition() {
            const canFinish = (stats.points >= MIN_POINTS && stats.questions >= MIN_QUESTIONS);
            
            const btnNext = document.getElementById('btn-next');
            const btnFinish = document.getElementById('btn-finish');

            if (canFinish) {
                btnFinish.classList.remove('hidden');
                btnFinish.classList.add('flex');
                btnNext.classList.remove('bg-slate-800', 'hover:bg-slate-900');
                btnNext.classList.add('bg-slate-400', 'hover:bg-slate-500'); 
            }
        }

        function finishExam() {
            document.getElementById('exam-section').classList.add('hidden');
            document.getElementById('finish-section').classList.remove('hidden');
            document.getElementById('final-points').innerText = stats.points;
            document.getElementById('final-count').innerText = stats.questions;
            
            // Render History
            renderHistory();
        }
        
        function renderHistory() {
            const container = document.getElementById('history-list');
            container.innerHTML = '';
            
            if(history.length === 0) {
                container.innerHTML = '<p class="text-slate-400 italic">Keine Fragen gewertet.</p>';
                return;
            }

            history.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = "bg-slate-50 rounded-lg p-4 border border-slate-200";
                
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <span class="bg-indigo-100 text-indigo-700 text-xs font-bold px-2 py-1 rounded">Frage ${index + 1} (ID: ${item.id})</span>
                        <span class="text-sm font-semibold text-slate-500">${item.points} Pkt.</span>
                    </div>
                    <div class="text-slate-800 mb-0 prose max-w-none text-sm">${parseMarkdown(item.text)}</div>
                `;
                container.appendChild(div);
            });
            
            // Trigger MathJax for the new elements
            if (window.MathJax) {
                MathJax.typesetPromise([container]).catch((err) => console.log(err));
            }
        }

        function resetApp() {
            if(confirm("Wollen Sie die aktuelle Sitzung wirklich zurücksetzen?")) {
                location.reload();
            }
        }

    </script>
</body>
</html>
